<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">

<HTML>
<HEAD>
<TITLE>OZ Manual</TITLE>
</HEAD>

<BODY>

<CENTER>
<H4>安全なセルのプログラミングのためのガイドライン</H4>
</CENTER>

<HR noshade>

<P>
<UL>
  <LI> <A HREF="#intercellsecurity">OZ のセル間セキュリティモデル</A>
  <LI> <A HREF="#intracellsecurity">OZ のセル内セキュリティモデル</A>
  <LI> <A HREF="#securecell">セキュアなセルの設計</A>
  <LI> <A HREF="#ACL">ACL Libraryによるセキュアプログラミング例</A>
</UL>
<HR>

<A NAME="intercellsecurity"></A>
<H5>OZ のセル間セキュリティモデル</H5>
<UL>
  <LI> 認証<BR>
       セルには重要な情報が含まれている場合がある。
       したがって、セルの内容を読み出したり改変したりできるユーザを
       制限したいという場合は頻繁に生じる。
       しかし、クラスのインタフェースはメソッドシグネチャで規定されるので、
       あるユーザにある操作を許すとすれば、そのためのメソッドが必要となり、
       そのメソッドを誰もが起動可能だとすると、誰もが改変可能になってしまう。
       そこで、実行時に、そのメソッドを呼び出したユーザ (caller ユーザ) が
       誰であるかを特定し、 
       caller ユーザがそのメソッドを起動する権限を持っているかどうかを確認する
       ことが必要となる。
       この手続きを ``認証'' と呼ぶ。 

  <LI> ユーザ<BR>
       OZ では、同じ OZ ホーム上のオブジェクトは、
       すべて同じユーザの所有物と考える。
       また、異なる OZ ホームのオーナは、
       実際は同一人物であってもシステム上は別のユーザと考える。
       すなわち、ユーザは OZ ホーム ID によって識別される。

  <LI> アクセス制御<BR>
       認証の実現には特別な手順が必要だが、その大部分は認証サーバが行う。
       セルのプログラマがやらなければならないのは、
       その caller ユーザがそのメソッドを起動してよいかどうかを
       判断するためのプログラミングである。
       これを“アクセス制御”と呼ぶ。
       アクセス制御のプログラミングのために、
       OZ では、“ACL ライブラリ”が用意されている。
</UL>
<HR>

<A NAME="intracellsecurity"></A>
<H5>OZ のセル内セキュリティモデル</H5>
リモートメソッド起動によってセルの外部からもたらされたオブジェクトは、
未知のクラスのインスタンスであるかもしれず、
どのような挙動を示すか予測できない。
これらの危険なオブジェクトから、
セルの内部にある重要なオブジェクトや、ホストシステムを保護する必要がある。
しかし、セルの中にまで、セル間セキュリティのような認証に基づくアクセス制御を
持ち込むと、効率上の問題がある。
そこで、以下のようにして解決する。
<UL>
  <LI> オブジェクトの色<BR>
       危険なオブジェクトに、重要なオブジェクトのメソッドを起動させないために、
       次のようにオブジェクトを色分けする。<BR>
       <UL>
	 <LI> 緑オブジェクト<BR>
	      最初からセル内に存在するオブジェクトは、
	      安全であることを示すために、緑に塗る。
	      緑オブジェクトが生成するオブジェクトは緑オブジェクトである。
	 <LI> 赤オブジェクト<BR>
	      RMI によってセルの外部からもたらされるオブジェクトは、
	      危険であることを示すために、赤く塗る。
	      赤オブジェクトが生成するオブジェクトもまた赤オブジェクトである。
	 <LI> アクセス制限<BR>
	      赤オブジェクトは緑オブジェクトのメソッドを起動できない。
       </UL>
       オブジェクトやスレッドの色分けと、それに基づくアクセス制限は、
       <B>OzVM</B>とコンパイラによって実現され、
       OZ のプログラマは記述しない。

  <LI> ホストシステムの保護<BR>
       ホストシステム上の資源 (ファイル、通信ポート、外部プロセスなど) に
       対するアクセスは、 Java Applet と同様に、一定の方針で制限される。 
       Java Applet では、
       このためにクライアント側で状態を保存できないという問題が生じたが、
       赤オブジェクトは、それ自体をセルの一部として保存することが可能であり、
       問題とはならない。<BR>
       緑オブジェクトに対しても、
       ホストシステムに回復不能な破壊が生じる可能性のある挙動 
       (OZ ホームの外部のファイルの上書き、外部コマンドの実行など) は、
       制限されたり、許可を求めたりするようになっている。
       これは、
       緑オブジェクトといえども完全に信用はできない場合に備えた設計である。
       そのような状況としては、例えば、開発初期の、
       セキュリティホールをかかえた状態のプログラムを試験する
       場合などを想定している。

  <LI> 赤オブジェクトによるリモートメソッド起動<BR>
       赤オブジェクトによるリモートメソッド起動が、
       そのオーナの権限で実行されると、
       同じオーナの所有する他のセルを破壊できてしまう。
       これを防ぐため、赤オブジェクトによるリモートメソッド起動は、
       システム定義のユーザ ``nobody'' の権限で実行される。
       また、セル内の緑オブジェクトをリモートメソッド起動の
       引数としてどこかへ持ち出されないために、
       赤オブジェクトが緑オブジェクトを引数にしてリモートメソッド起動を
       実行するのは禁止されている。
</UL>
<HR>

<A NAME="securecell"></A>
<H5>セキュアなセルの設計</H5>
OZ では、セル間およびセル内でのセキュリティ維持の機能が提供されているが、
これらを有効に活用するためには、
セルのプログラマが適切なセキュリティ設計を行う必要がある。
<UL>
  <LI> メソッドの設計<BR>
       セルのメソッドは、次の二種類に分けて設計すべきである。
       <UL>
	 <LI> 特定のユーザのみが起動できるメソッド<BR>
	      必ずメソッドの先頭で caller ユーザを確認する。<BR>
	      リモートメソッド起動によって送り込まれるオブジェクトが、
	      同じオーナのセル間でのみ起動されるメソッドによって
	      送り込まれるものであって、
	      なおかつ、そのクラスが安全であるとあらかじめ分かっている場合は、
	      赤オブジェクトのままにしておく必要はない。
	      緑スレッドは赤オブジェクトを緑オブジェクトに変更できるので、
	      緑オブジェクトに変更すると、設計が簡単になる。<BR>
	      すなわち、オーナだけが起動できるメソッドでは、
	      その引数のオブジェクトの色を赤のままにしておくのか、
	      緑に変更するのかを設計する。
	      同様に、同じオーナの他のセルに対するリモートメソッド起動では、
	      その返り値のオブジェクトの色を緑に変更するかどうかを設計する。

	 <LI> 不特定多数が起動できるメソッド<BR>
	      どのような呼ばれ方をしても、
	      セル自身の一貫性やサービス提供能力に
	      ダメージを与えられないように設計する。
	      そのような副作用を引き起こすためのメソッドは、
	      起動できるユーザを限定する。
       </UL>

  <LI> オブジェクトの設計<BR>
       セル内のオブジェクトについては、以下のように設計すべきである。
       <UL>
	 <LI> 赤オブジェクトの分離<BR>
	      赤オブジェクトに対するメソッド起動は終了しない場合が考えられ、
	      一般にタイムアウトをかけるべきである。
	      これはプログラミングによって解決するよりないので、
	      セル内では、どのオブジェクトが赤である可能性があるのかが、
	      プログラミングの際に明らかになっていなければならない。<BR>
	      リモートメソッド起動の引数や返り値を直接扱う部分では、
	      これは自明であるが、
	      セルの一部として永続化する場合には注意が必要である。
	      その場合は、例えば、
	      赤オブジェクトはひとつのテーブルの内部に閉じ込めるような
	      設計とし、
	      それ以外の部分に紛れ込まないようにすれば、
	      プログラミング時に赤オブジェクトの可能性があるかどうかを
	      認識しやすい。
	 <LI> 赤オブジェクトへの引数渡し<BR>
	      赤オブジェクトへのメソッド起動の引数として
	      オブジェクトを渡す場合は、
	      通常、赤オブジェクトからのそのオブジェクトの
	      メソッドが起動できなければならない。<BR>
	      赤オブジェクトからのメソッド起動を受けられるのは
	      赤オブジェクトだけなので、
	      緑オブジェクトを引き渡す場合は、
	      赤オブジェクトに変更してから渡す必要がある。
	      赤オブジェクトを保護することはできないので、
	      破壊されると困るオブジェクトを渡す場合は、
	      ディープコピーしてから色を変更して引き渡す必要がある。
	      そのオブジェクトがさらに緑オブジェクトへの参照を持つ場合、
	      この色の変更とコピーは、
	      必要に応じて再帰的に実行しなければならない。
	      したがって、セルを設計する際には、
	      赤オブジェクトに対するメソッド起動の引数に、
	      そのような再帰的な色の変更やコピーの難しいオブジェクトを
	      与えるような設計にすべきではない。
	      どうしてもそれが必要である場合、
	      そのようなオブジェクトを赤オブジェクトとして引き渡すのではなく、
	      別のセルにしてしまうことも検討するとよい。
       </UL>

  <LI> セル構造の設計<BR>
       セルは、以下のような構造になるように設計すべきである。
       <UL>
	 <LI> 赤オブジェクトどうしの分離<BR>
	      赤オブジェクトが赤オブジェクトからメソッド起動される場合は、
	      緑オブジェクトに対するような保護機構は働かない。
	      したがって、
	      赤オブジェクトに別の赤オブジェクトを直接操作させると、
	      破壊されるおそれがある。
	      このため、セルの設計者は、
	      セルの内部で赤オブジェクトどうしが不必要に接触しないように
	      設計しなくてはならない。<BR>
	      特に、クラスメソッドを通じて接触できないように注意する。
	 <LI> 赤オブジェクトどうしが接触する場合<BR>
	      前項に関わらず、セルの提供する機能の性質上、どうしても
	      セル内部で赤オブジェクトどうしを
	      接触させなくてはならない場合もある。
	      この場合、セルの設計を工夫するだけでは、
	      これらの赤オブジェクトどうしが破壊し合うのを防ぐことはできない。
	      赤オブジェクトが破壊されることによって
	      セルに直接の被害が生じるわけではないが、
	      そのセルが提供するサービスが利用不能になったり
	      品質が低下することが考えられる。
	      これを防ぐには、
	      このようなセルの内部で活動させる目的で送り込まれる
	      オブジェクトを、
	      メソッド起動によって破壊されないようにプログラムさせる。
	      そのようなオブジェクトどうしは、他のセルで出会っても、
	      互いを破壊することはできない。
	      セルの設計者は、
	      しばしばこのようなオブジェクトの抽象クラスを提供するが、
	      以上から、その抽象クラスのインタフェースには、
	      状態を変更するようなメソッドは含められないことが分かる。
	      このようなオブジェクトは、
	      一般的な用途に用いるのは不便なことが多く、
	      通常はこの目的のために特に設計されるクラスとなるだろう。
       </UL>
</UL>
<HR>

<A NAME="ACL"></A>
<H5>ACL Libraryによるセキュアプログラミング例</H5>
<UL>
<PRE>
cell ASecureCell{
  AccessControlList owner, clients;
  new create(){
      //そのセルのオーナだけを含んだ authorized users list を作る。
      owner=>ownerOnly();
      //新しい空の authorized users list を作る。
      clients=>create();
      /*
       * clients の初期 member を適切に設定する。
       */
  }
  // オーナ限定のメソッド
  public void aSecureMethodA(){
      owner->authenticate();
          :    // あとは普通に処理を書いていく
  }
  // あるユーザグループ (clients) 限定のメソッド
  public void aSecureMethodB(){
      clients->authenticate();
          :    // あとは普通に処理を書いていく
  }
}
</PRE>
</UL>
</P>

<HR noshade>

<ADDRESS><B> <A href="copyright-j.html">Copyright</A>(c) 1996-1998 IPA,
ETL, AT21, FSIABC, FXIS, InArc, MRI, NUL, SBC, Sharp, TEC, TIS </B></ADDRESS>
<P>
<B>Contact: <A href="mailto:oz-admin@oz.ipa.go.jp">oz-admin@oz.ipa.go.jp</A></B>
</P>
</BODY>
</HTML>
